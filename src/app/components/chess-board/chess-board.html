<div class="chess-container">
  <!-- Game Controls -->
  <div class="controls-panel controls-area">
    <h2 class="text-2xl font-semibold mb-4 text-white">Chess Teacher</h2>

    <!-- Game Status -->
    @if (isCheck() || isCheckmate() || isStalemate()) {
    <app-game-status
      [isCheck]="isCheck()"
      [isCheckmate]="isCheckmate()"
      [isStalemate]="isStalemate()"
    ></app-game-status>
    }

    <!-- Action Buttons -->
    <app-action-buttons
      [isMultiplayerMode]="isMultiplayerMode()"
      (resetGame)="resetGame()"
      (undoMove)="undoMove()"
      (flipBoard)="flipBoard()"
      (toggleOptions)="toggleOptions()"
      (openConnectionDialog)="openConnectionDialog()"
      (disconnectMultiplayer)="disconnectMultiplayer()"
      (toggle3d)="toggle3dMode()"
    />

    <!-- Move History -->
    <app-move-history [movePairs]="movePairs()" (goToMove)="goToMove($event)"></app-move-history>

    <!-- Multiplayer Status -->
    @if (isMultiplayerMode()) {
    <app-multiplayer-status
      [connectionStatus]="connectionStatus()"
      [multiplayerRole]="multiplayerRole()"
      [isMyTurn]="isMyTurn()"
    ></app-multiplayer-status>
    }
  </div>

  <!-- Analysis Panel -->
  <div class="side-panel">
    <app-analysis-panel [fen]="fen()"></app-analysis-panel>

    <button (click)="toggleOpeningGraph()" class="btn btn-multiplayer w-full mb-4 justify-center">
      <span class="material-icons">map</span>
      Opening Map
    </button>
    <app-opening-explorer
      [fen]="fen()"
      (moveSelected)="onOpeningMove($event)"
      (openingName)="onOpeningNameChange($event)"
    >
    </app-opening-explorer>
  </div>

  <!-- Chess Board -->
  <div class="board-wrapper board-area">
    <div
      class="flex items-stretch justify-center gap-4 w-full"
      [class.flex-col]="isSmallScreen()"
      [class.flex-row]="!isSmallScreen()"
    >
      <!-- Left Player Info (Opponent) -->
      <div
        class="player-info side flex flex-col justify-center items-center px-3 py-4 rounded-lg border transition-all duration-300 self-stretch"
        [ngClass]="{
          '!w-auto !max-w-none min-w-[3.5rem]': !isSmallScreen(),
          'w-full': isSmallScreen()
        }"
        [class]="
          orientation() === 'white'
            ? 'bg-slate-950/40 border-slate-800/50'
            : 'bg-slate-300/20 border-slate-200/30'
        "
        [class.active-turn]="
          (orientation() === 'white' && turn() === 'black') ||
          (orientation() === 'black' && turn() === 'white')
        "
      >
        @if (orientation() === 'white') {
        <!-- Opponent is Black -->
        <app-captured-pieces
          [pieces]="capturedByBlack()"
          color="white"
          [pieceTheme]="currentPieceTheme()"
          [orientation]="isSmallScreen() ? 'horizontal' : 'vertical'"
        ></app-captured-pieces>
        } @else {
        <!-- Opponent is White -->
        <app-captured-pieces
          [pieces]="capturedByWhite()"
          color="black"
          [pieceTheme]="currentPieceTheme()"
          [orientation]="isSmallScreen() ? 'horizontal' : 'vertical'"
        ></app-captured-pieces>
        }
      </div>

      <div class="flex flex-col items-center gap-2 shrink-0">
        <div class="board-header">
          @if(openingName()) {
          <span class="opening-label">{{ openingName() }}</span>
          }
        </div>

        @if (is3dMode()) {
        <app-chess-board-3d
          [fen]="fen()"
          [orientation]="orientation()"
          [boardTheme]="currentBoardTheme()"
          (move)="on3dMove($event)"
          class="chessboard-3d"
        ></app-chess-board-3d>
        } @else {
        <div
          #board
          class="chessboard theme-{{ currentBoardTheme() }} pieces-{{ currentPieceTheme() }}"
        ></div>
        }
      </div>

      <!-- Right Player Info (Self) -->
      <div
        class="player-info side flex flex-col justify-center items-center px-3 py-4 rounded-lg border transition-all duration-300 self-stretch"
        [ngClass]="{
          '!w-auto !max-w-none min-w-[3.5rem]': !isSmallScreen(),
          'w-full': isSmallScreen()
        }"
        [class]="
          orientation() === 'white'
            ? 'bg-slate-300/20 border-slate-200/30'
            : 'bg-slate-950/40 border-slate-800/50'
        "
        [class.active-turn]="
          (orientation() === 'white' && turn() === 'white') ||
          (orientation() === 'black' && turn() === 'black')
        "
      >
        @if (orientation() === 'white') {
        <!-- Self is White -->
        <app-captured-pieces
          [pieces]="capturedByWhite()"
          color="black"
          [pieceTheme]="currentPieceTheme()"
          [orientation]="isSmallScreen() ? 'horizontal' : 'vertical'"
        ></app-captured-pieces>
        } @else {
        <!-- Self is Black -->
        <app-captured-pieces
          [pieces]="capturedByBlack()"
          color="white"
          [pieceTheme]="currentPieceTheme()"
          [orientation]="isSmallScreen() ? 'horizontal' : 'vertical'"
        ></app-captured-pieces>
        }
      </div>
    </div>

    <!-- Game Navigation -->
    <div
      class="navigation-controls flex justify-center gap-2 my-2 p-2 bg-slate-700/30 rounded-lg border border-slate-600/30 w-full max-w-[600px] mx-auto"
    >
      <button
        class="btn btn-secondary !px-4 !py-2"
        (click)="goToStart()"
        [title]="'GAME.NAV_START' | translate"
      >
        <span class="material-icons btn-icon text-lg">first_page</span>
      </button>
      <button
        class="btn btn-secondary !px-4 !py-2"
        (click)="stepBack()"
        [title]="'GAME.NAV_PREV' | translate"
      >
        <span class="material-icons btn-icon text-lg">chevron_left</span>
      </button>
      <button
        class="btn btn-secondary !px-4 !py-2"
        (click)="stepForward()"
        [title]="'GAME.NAV_NEXT' | translate"
      >
        <span class="material-icons btn-icon text-lg">chevron_right</span>
      </button>
      <button
        class="btn btn-secondary !px-4 !py-2"
        (click)="goToEnd()"
        [title]="'GAME.NAV_END' | translate"
      >
        <span class="material-icons btn-icon text-lg">last_page</span>
      </button>
    </div>

    <app-ai-assistant
      [currentFen]="fen()"
      (suggestionClicked)="makeSuggestedMove($event)"
    ></app-ai-assistant>
  </div>

  <app-options-dialog
    [visible]="showOptions()"
    [currentBoardTheme]="currentBoardTheme()"
    [currentPieceTheme]="currentPieceTheme()"
    [whitePlayerType]="whitePlayerType()"
    [blackPlayerType]="blackPlayerType()"
    [whiteComputerElo]="whiteComputerElo()"
    [blackComputerElo]="blackComputerElo()"
    [currentLanguage]="language()"
    (close)="showOptions.set(false)"
    (settingsChange)="updateSettings($event)"
  >
  </app-options-dialog>

  <!-- Connection Dialog -->
  @if (showConnectionDialog()) {
  <app-connection-dialog
    (close)="closeConnectionDialog()"
    (connected)="onConnectionEstablished($event)"
  >
  </app-connection-dialog>
  } @if (showOpeningGraph()) {
  <app-opening-graph (close)="toggleOpeningGraph()"></app-opening-graph>
  }

  <!-- Promotion Dialog -->
  <app-promotion-dialog
    [visible]="showPromotionDialog()"
    [color]="promotionColor"
    [pieceTheme]="currentPieceTheme()"
    (promotionSelected)="onPromotionSelected($event)"
    (cancelled)="onPromotionCancelled()"
  ></app-promotion-dialog>
</div>

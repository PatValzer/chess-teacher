<div class="chess-container">
  <!-- Game Controls -->
  <div class="controls-panel controls-area">
    <h2 class="text-2xl font-semibold mb-4 text-white" style="color: var(--panel-text, white)">
      Chess Teacher
    </h2>

    <!-- Game Status -->
    @if (isCheck() || isCheckmate() || isStalemate()) {
    <app-game-status
      [isCheck]="isCheck()"
      [isCheckmate]="isCheckmate()"
      [isStalemate]="isStalemate()"
    ></app-game-status>
    }

    <!-- Action Buttons -->
    <app-action-buttons
      [isMultiplayerMode]="isMultiplayerMode()"
      [is3dMode]="is3dMode()"
      (resetGame)="resetGame()"
      (undoMove)="undoMove()"
      (flipBoard)="flipBoard()"
      (toggleOptions)="toggleOptions()"
      (openConnectionDialog)="openConnectionDialog()"
      (disconnectMultiplayer)="disconnectMultiplayer()"
      (toggle3d)="toggle3dMode()"
    />

    <!-- Move History -->
    <app-move-history [movePairs]="movePairs()" (goToMove)="goToMove($event)"></app-move-history>

    <!-- Multiplayer Status -->
    @if (isMultiplayerMode()) {
    <app-multiplayer-status
      [connectionStatus]="connectionStatus()"
      [multiplayerRole]="multiplayerRole()"
      [isMyTurn]="isMyTurn()"
    ></app-multiplayer-status>
    }
  </div>

  <!-- Analysis Panel -->
  <div class="side-panel">
    <app-analysis-panel [fen]="fen()"></app-analysis-panel>

    <app-opening-map-button (clicked)="toggleOpeningGraph()"></app-opening-map-button>

    <app-opening-explorer
      [fen]="fen()"
      (moveSelected)="onOpeningMove($event)"
      (openingName)="onOpeningNameChange($event)"
    >
    </app-opening-explorer>
  </div>

  <!-- Chess Board -->
  <div class="board-wrapper board-area">
    <div
      class="gap-4 w-full"
      [class.flex]="isSmallScreen()"
      [class.flex-col]="isSmallScreen()"
      [class.grid]="!isSmallScreen()"
      [class.grid-cols-[auto_1fr_auto]]="!isSmallScreen()"
      [class.justify-center]="!isSmallScreen()"
    >
      <!-- Left Player Info (Opponent) -->
      <app-player-info
        [color]="orientation() === 'white' ? 'black' : 'white'"
        [isActive]="turn() !== orientation()"
        [capturedPieces]="orientation() === 'white' ? capturedByBlack() : capturedByWhite()"
        [pieceTheme]="currentPieceTheme()"
        [isSmallScreen]="isSmallScreen()"
      ></app-player-info>

      <div class="flex flex-col items-center gap-2 shrink-0">
        <div class="board-header">
          @if(openingName()) {
          <span class="opening-label">{{ openingName() }}</span>
          }
        </div>

        @if (is3dMode()) {
        <app-chess-board-3d
          [fen]="fen()"
          [orientation]="orientation()"
          [boardTheme]="currentBoardTheme()"
          (move)="on3dMove($event)"
          class="chessboard-3d"
        ></app-chess-board-3d>
        } @else {
        <app-chess-board-2d
          [fen]="fen()"
          [orientation]="orientation()"
          [turnColor]="turn()"
          [validMoves]="validMoves()"
          [lastMove]="lastMove()"
          [isCheck]="isCheck()"
          [boardTheme]="currentBoardTheme()"
          [pieceTheme]="currentPieceTheme()"
          (move)="onMove($event.from, $event.to)"
          class="chessboard"
        ></app-chess-board-2d>

        }
      </div>

      <!-- Right Player Info (Self) -->
      <app-player-info
        [color]="orientation()"
        [isActive]="turn() === orientation()"
        [capturedPieces]="orientation() === 'white' ? capturedByWhite() : capturedByBlack()"
        [pieceTheme]="currentPieceTheme()"
        [isSmallScreen]="isSmallScreen()"
      ></app-player-info>

      <!-- Game Navigation -->
      <app-game-navigation
        class="col-span-3 w-full"
        [canUndo]="canUndo()"
        [canRedo]="canRedo()"
        (first)="goToStart()"
        (previous)="stepBack()"
        (next)="stepForward()"
        (last)="goToEnd()"
      ></app-game-navigation>
    </div>

    <app-ai-assistant
      [currentFen]="fen()"
      (suggestionClicked)="makeSuggestedMove($event)"
    ></app-ai-assistant>
  </div>

  <app-options-dialog
    [visible]="showOptions()"
    [currentBoardTheme]="currentBoardTheme()"
    [currentPieceTheme]="currentPieceTheme()"
    [currentAppTheme]="currentAppTheme()"
    [whitePlayerType]="whitePlayerType()"
    [blackPlayerType]="blackPlayerType()"
    [whiteComputerElo]="whiteComputerElo()"
    [blackComputerElo]="blackComputerElo()"
    [currentLanguage]="language()"
    (close)="showOptions.set(false)"
    (settingsChange)="updateSettings($event)"
  >
  </app-options-dialog>

  <!-- Connection Dialog -->
  @if (showConnectionDialog()) {
  <app-connection-dialog
    (close)="closeConnectionDialog()"
    (connected)="onConnectionEstablished($event)"
  >
  </app-connection-dialog>
  } @if (showOpeningGraph()) {
  <app-opening-graph (close)="toggleOpeningGraph()"></app-opening-graph>
  }

  <!-- Promotion Dialog -->
  <app-promotion-dialog
    [visible]="showPromotionDialog()"
    [color]="promotionColor"
    [pieceTheme]="currentPieceTheme()"
    (promotionSelected)="onPromotionSelected($event)"
    (cancelled)="onPromotionCancelled()"
  ></app-promotion-dialog>
</div>

<div class="chess-container">
  <!-- Game Controls -->
  <div class="controls-panel controls-area">
    <h2 class="text-2xl font-semibold mb-4 text-white">Chess Teacher</h2>

    <!-- Game Status -->
    @if (isCheck() || isCheckmate() || isStalemate()) {
    <app-game-status
      [isCheck]="isCheck()"
      [isCheckmate]="isCheckmate()"
      [isStalemate]="isStalemate()"
    ></app-game-status>
    }

    <!-- Action Buttons -->
    <app-action-buttons
      [isMultiplayerMode]="isMultiplayerMode()"
      (resetGame)="resetGame()"
      (undoMove)="undoMove()"
      (flipBoard)="flipBoard()"
      (toggleOptions)="toggleOptions()"
      (openConnectionDialog)="openConnectionDialog()"
      (disconnectMultiplayer)="disconnectMultiplayer()"
      (toggle3d)="toggle3dMode()"
    />

    <!-- Move History -->
    <app-move-history [movePairs]="movePairs()" (goToMove)="goToMove($event)"></app-move-history>

    <!-- Multiplayer Status -->
    @if (isMultiplayerMode()) {
    <app-multiplayer-status
      [connectionStatus]="connectionStatus()"
      [multiplayerRole]="multiplayerRole()"
      [isMyTurn]="isMyTurn()"
    ></app-multiplayer-status>
    }
  </div>

  <!-- Analysis Panel -->
  <div class="side-panel">
    <app-analysis-panel [fen]="fen()"></app-analysis-panel>

    <button
      (click)="toggleOpeningGraph()"
      class="w-full mb-4 py-3 px-4 bg-gradient-to-r from-teal-600 to-teal-500 hover:from-teal-500 hover:to-teal-400 text-white rounded-lg font-semibold shadow-lg transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2 border border-teal-400/30"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
        <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
      </svg>
      Opening Map
    </button>
    <app-opening-explorer
      [fen]="fen()"
      (moveSelected)="onOpeningMove($event)"
      (openingName)="onOpeningNameChange($event)"
    >
    </app-opening-explorer>
  </div>

  <!-- Chess Board -->
  <div class="board-wrapper board-area">
    <div class="flex flex-row items-center justify-center gap-4 w-full">
      <!-- Left Player Info (Opponent) -->
      <div
        class="player-info side !w-auto !max-w-none flex flex-col items-center px-3 py-4 bg-slate-800/40 rounded-lg border border-slate-700/30 min-w-[3.5rem] transition-all duration-300 self-stretch"
        [class.active-turn]="
          (orientation() === 'white' && turn() === 'black') ||
          (orientation() === 'black' && turn() === 'white')
        "
      >
        @if (orientation() === 'white') {
        <app-captured-pieces
          [pieces]="capturedByBlack()"
          color="white"
          [pieceTheme]="currentPieceTheme()"
          orientation="vertical"
        ></app-captured-pieces>
        } @else {
        <app-captured-pieces
          [pieces]="capturedByWhite()"
          color="black"
          [pieceTheme]="currentPieceTheme()"
          orientation="vertical"
        ></app-captured-pieces>
        }
      </div>

      <div class="flex flex-col items-center gap-2">
        <div class="board-header">
          @if(openingName()) {
          <span class="opening-label">{{ openingName() }}</span>
          }
        </div>

        @if (is3dMode()) {
        <app-chess-board-3d
          [fen]="fen()"
          [orientation]="orientation()"
          [boardTheme]="currentBoardTheme()"
          (move)="on3dMove($event)"
          class="chessboard-3d"
        ></app-chess-board-3d>
        } @else {
        <div
          #board
          class="chessboard theme-{{ currentBoardTheme() }} pieces-{{ currentPieceTheme() }}"
        ></div>
        }
      </div>

      <!-- Right Player Info (Self) -->
      <div
        class="player-info side !w-auto !max-w-none flex flex-col items-center px-3 py-4 bg-slate-800/40 rounded-lg border border-slate-700/30 min-w-[3.5rem] transition-all duration-300 self-stretch"
        [class.active-turn]="
          (orientation() === 'white' && turn() === 'white') ||
          (orientation() === 'black' && turn() === 'black')
        "
      >
        @if (orientation() === 'white') {
        <app-captured-pieces
          [pieces]="capturedByWhite()"
          color="black"
          [pieceTheme]="currentPieceTheme()"
          orientation="vertical"
        ></app-captured-pieces>
        } @else {
        <app-captured-pieces
          [pieces]="capturedByBlack()"
          color="white"
          [pieceTheme]="currentPieceTheme()"
          orientation="vertical"
        ></app-captured-pieces>
        }
      </div>
    </div>

    <!-- Game Navigation -->
    <div
      class="navigation-controls flex justify-center gap-2 my-2 p-2 bg-slate-700/30 rounded-lg border border-slate-600/30 w-full max-w-[600px] mx-auto"
    >
      <button
        class="btn btn-secondary !px-4 !py-2"
        (click)="goToStart()"
        [title]="'GAME.NAV_START' | translate"
      >
        <span class="btn-icon text-lg">⏮</span>
      </button>
      <button
        class="btn btn-secondary !px-4 !py-2"
        (click)="stepBack()"
        [title]="'GAME.NAV_PREV' | translate"
      >
        <span class="btn-icon text-lg">◀</span>
      </button>
      <button
        class="btn btn-secondary !px-4 !py-2"
        (click)="stepForward()"
        [title]="'GAME.NAV_NEXT' | translate"
      >
        <span class="btn-icon text-lg">▶</span>
      </button>
      <button
        class="btn btn-secondary !px-4 !py-2"
        (click)="goToEnd()"
        [title]="'GAME.NAV_END' | translate"
      >
        <span class="btn-icon text-lg">⏭</span>
      </button>
    </div>

    <app-ai-assistant
      [currentFen]="fen()"
      (suggestionClicked)="makeSuggestedMove($event)"
    ></app-ai-assistant>
  </div>

  <app-options-dialog
    [visible]="showOptions()"
    [currentBoardTheme]="currentBoardTheme()"
    [currentPieceTheme]="currentPieceTheme()"
    [whitePlayerType]="whitePlayerType()"
    [blackPlayerType]="blackPlayerType()"
    [whiteComputerElo]="whiteComputerElo()"
    [blackComputerElo]="blackComputerElo()"
    [currentLanguage]="language()"
    (close)="showOptions.set(false)"
    (settingsChange)="updateSettings($event)"
  >
  </app-options-dialog>

  <!-- Connection Dialog -->
  @if (showConnectionDialog()) {
  <app-connection-dialog
    (close)="closeConnectionDialog()"
    (connected)="onConnectionEstablished($event)"
  >
  </app-connection-dialog>
  } @if (showOpeningGraph()) {
  <app-opening-graph (close)="toggleOpeningGraph()"></app-opening-graph>
  }

  <!-- Promotion Dialog -->
  <app-promotion-dialog
    [visible]="showPromotionDialog()"
    [color]="promotionColor"
    [pieceTheme]="currentPieceTheme()"
    (promotionSelected)="onPromotionSelected($event)"
    (cancelled)="onPromotionCancelled()"
  ></app-promotion-dialog>
</div>

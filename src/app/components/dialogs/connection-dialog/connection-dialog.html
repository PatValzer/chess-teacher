<div class="dialog-overlay" (click)="closeDialog()">
  <div class="dialog-content" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="dialog-header">
      <h2>üîó {{ 'P2P.TITLE' | translate }}</h2>
      <button class="close-btn" (click)="closeDialog()" aria-label="Close">√ó</button>
    </div>

    <!-- Error Message -->
    @if (errorMessage()) {
    <div class="error-banner">‚ö†Ô∏è {{ errorMessage() }}</div>
    }

    <!-- Step 1: Choose Role -->
    @if (currentStep() === 'choose-role') {
    <div class="step-content">
      <p class="instruction">{{ 'P2P.CHOOSE_ROLE' | translate }}</p>

      <div class="role-buttons">
        <button class="role-btn host-btn" (click)="chooseHost()">
          <div class="role-icon material-icons">sports_esports</div>
          <div class="role-title">{{ 'P2P.HOST_GAME' | translate }}</div>
          <div class="role-description">{{ 'P2P.HOST_DESC' | translate }}</div>
        </button>

        <button class="role-btn guest-btn" (click)="chooseGuest()">
          <div class="role-icon material-icons">group_add</div>
          <div class="role-title">{{ 'P2P.JOIN_GAME' | translate }}</div>
          <div class="role-description">{{ 'P2P.JOIN_DESC' | translate }}</div>
        </button>
      </div>

      <div class="info-box">
        <strong>{{ 'P2P.HOW_IT_WORKS' | translate }}</strong>
        <ol>
          <li>{{ 'P2P.STEP1' | translate }}</li>
          <li>{{ 'P2P.STEP2' | translate }}</li>
          <li>{{ 'P2P.STEP3' | translate }}</li>
          <li>{{ 'P2P.STEP4' | translate }}</li>
        </ol>
      </div>
    </div>
    }

    <!-- Step 2: Host Waiting for Guest -->
    @if (currentStep() === 'host-waiting') {
    <div class="step-content">
      @if (isGeneratingOffer()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>{{ 'P2P.GEN_CODE' | translate }}</p>
      </div>
      } @else {
      <div class="qr-section">
        <p class="instruction">{{ 'P2P.SHARE_CODE' | translate }}</p>

        @if (offerQRCode()) {
        <div class="qr-code-container">
          <img [src]="offerQRCode()" alt="Connection QR Code" class="qr-code" />
        </div>
        }

        <div class="code-actions">
          <button class="copy-btn" (click)="copyToClipboard(offerData(), 'offer')">
            <span class="material-icons">content_copy</span> {{ 'P2P.COPY_CODE' | translate }}
          </button>
        </div>

        <details class="code-details">
          <summary>{{ 'P2P.SHOW_CODE' | translate }}</summary>
          <textarea [value]="offerData()" readonly class="code-textarea" rows="4"></textarea>
        </details>

        <hr class="divider" />

        <p class="instruction">{{ 'P2P.PASTE_RESPONSE' | translate }}</p>

        <textarea
          class="input-textarea"
          [placeholder]="'P2P.PASTE_RESPONSE_PH' | translate"
          rows="4"
          (input)="updateScannedAnswer($event)"
          [value]="scannedAnswerInput()"
        ></textarea>

        <div class="action-buttons">
          <button class="btn btn-secondary" (click)="goBack()">
            {{ 'SETTINGS.CANCEL' | translate }}
          </button>
          <button
            class="btn btn-primary"
            (click)="submitScannedAnswer()"
            [disabled]="!scannedAnswerInput() || isProcessingAnswer()"
          >
            @if (isProcessingAnswer()) {
            <span class="btn-spinner"></span>
            {{ 'P2P.PROCESSING' | translate }} } @else { {{ 'P2P.CONNECT' | translate }} }
          </button>
        </div>
      </div>
      }
    </div>
    }

    <!-- Step 3: Guest Scanning Offer -->
    @if (currentStep() === 'guest-scanning') {
    <div class="step-content">
      <p class="instruction">{{ 'P2P.SCAN_OR_PASTE' | translate }}</p>

      <textarea
        class="input-textarea"
        [placeholder]="'P2P.PASTE_OFFER_PH' | translate"
        rows="6"
        (input)="updateScannedOffer($event)"
        [value]="scannedOfferInput()"
        autofocus
      ></textarea>

      <div class="action-buttons">
        <button class="btn btn-secondary" (click)="goBack()">
          {{ 'SETTINGS.CANCEL' | translate }}
        </button>
        <button
          class="btn btn-primary"
          (click)="submitScannedOffer()"
          [disabled]="!scannedOfferInput() || isGeneratingAnswer()"
        >
          @if (isGeneratingAnswer()) {
          <span class="btn-spinner"></span>
          {{ 'P2P.PROCESSING' | translate }} } @else { {{ 'P2P.NEXT' | translate }} }
        </button>
      </div>
    </div>
    }

    <!-- Step 4: Guest Showing Answer -->
    @if (currentStep() === 'guest-showing-answer') {
    <div class="step-content">
      <p class="instruction">{{ 'P2P.SHARE_RESPONSE' | translate }}</p>

      @if (answerQRCode()) {
      <div class="qr-code-container">
        <img [src]="answerQRCode()" alt="Response QR Code" class="qr-code" />
      </div>
      }

      <div class="code-actions">
        <button class="copy-btn" (click)="copyToClipboard(answerData(), 'answer')">
          <span class="material-icons">content_copy</span> {{ 'P2P.COPY_RESPONSE' | translate }}
        </button>
      </div>

      <details class="code-details">
        <summary>{{ 'P2P.SHOW_CODE' | translate }}</summary>
        <textarea [value]="answerData()" readonly class="code-textarea" rows="4"></textarea>
      </details>

      <div class="waiting-message">
        <div class="pulse-dot"></div>
        <p>{{ 'P2P.WAITING_HOST' | translate }}</p>
      </div>

      <div class="action-buttons">
        <button class="btn btn-secondary" (click)="goBack()">
          {{ 'SETTINGS.CANCEL' | translate }}
        </button>
      </div>
    </div>
    }

    <!-- Step 5: Connected -->
    @if (currentStep() === 'connected') {
    <div class="step-content success-state">
      <div class="success-icon material-icons">check_circle</div>
      <h3>{{ 'P2P.CONNECTED_TITLE' | translate }}</h3>
      <p>{{ 'P2P.P2P_SUCCESS' | translate }}</p>
      <p class="sub-text">{{ 'P2P.STARTING' | translate }}</p>
    </div>
    }
  </div>
</div>
